import { useState, useEffect, useRef } from 'react'
import { useInfiniteQuery, useQuery } from '@tanstack/react-query'
import { Loader2 } from 'lucide-react'
import { getArticles, getCategories } from '@/api/article.ts'
import { useSearch } from '@/context/search-provider.tsx'
import { useDebounce } from '@/hooks/use-debounce.tsx'
import { ArticleCard } from '@/features/articles/components/article-card.tsx'
import { FilterBar } from '@/features/articles/components/filter-bar.tsx'

export function ArticlesMobile() {
  const { keyword } = useSearch()
  const debouncedKeyword = useDebounce(keyword, 300)
  const [filter, setFilter] = useState({
    page: 1,
    page_size: 10,
    keyword: '',
    section: '',
  })

  const loadMoreRef = useRef<HTMLDivElement>(null)

  const { data, fetchNextPage, hasNextPage, isFetchingNextPage, isLoading } =
    useInfiniteQuery({
      queryKey: ['articles-infinite', filter, debouncedKeyword],
      queryFn: async ({ pageParam = 1 }) => {
        const res = await getArticles({
          ...filter,
          page: pageParam,
          keyword: debouncedKeyword,
        })
        return res.data
      },
      getNextPageParam: (lastPage) => {
        return lastPage.hasMore ? lastPage.page + 1 : undefined
      },
      initialPageParam: 1,
      staleTime: 5 * 60 * 1000,
    })

  const { data: categories } = useQuery({
    queryKey: ['category'],
    queryFn: async () => {
      const res = await getCategories()
      return res.data
    },
    staleTime: 5 * 60 * 1000,
  })

  useEffect(() => {
    if (!loadMoreRef.current) return
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting && hasNextPage && !isFetchingNextPage) {
          fetchNextPage()
        }
      },
      {
        root: null,
        rootMargin: '100px',
      }
    )
    observer.observe(loadMoreRef.current)
    return () => observer.disconnect()
  }, [hasNextPage, isFetchingNextPage, fetchNextPage])

  const articles = data?.pages.flatMap((page) => page.items) || []
  const total = data?.pages[0]?.total || 0

  return (
    <div className='flex h-full flex-col overflow-hidden'>
      {/* ① 筛选栏 */}
      <div className='sticky top-0 z-30 mb-2'>
        <FilterBar
          value={filter}
          categories={categories || []}
          onChange={(v) => setFilter(v)}
        />
      </div>

      <div className='flex-1 overflow-auto'>
        <div className='grid gap-2'>
          {articles.map((article) => (
            <ArticleCard key={article.tid} article={article} />
          ))}
        </div>

        <div ref={loadMoreRef} className='py-4 text-center'>
          {isFetchingNextPage && (
            <div className='flex items-center justify-center gap-2 text-muted-foreground'>
              <Loader2 className='h-5 w-5 animate-spin' />
              <span>加载中...</span>
            </div>
          )}
          {!hasNextPage && articles.length > 0 && (
            <div className='text-sm text-muted-foreground'>
              已加载全部 {total} 条数据
            </div>
          )}
        </div>

        {isLoading && (
          <div className='flex items-center justify-center py-8'>
            <Loader2 className='h-6 w-6 animate-spin text-muted-foreground' />
          </div>
        )}
      </div>
    </div>
  )
}
